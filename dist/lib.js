var e=require("react"),t=require("prop-types"),n=require("escape-string-regexp"),o=require("@emotion/styled"),s=require("@emotion/react"),i=require("styled-system"),r=require("@emotion/css"),a=require("react-textarea-autosize");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d,u,p,h,c,f,g,b,m,y,v,w=/*#__PURE__*/l(e),x=/*#__PURE__*/l(t),C=/*#__PURE__*/l(n),k=/*#__PURE__*/l(o),S=/*#__PURE__*/l(a);function E(){return E=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},E.apply(this,arguments)}function K(e,t){return t||(t=e.slice(0)),e.raw=t,e}function P(e,t){return new RegExp(C.default(e||""),"i").test(t||"")}function O(e){void 0===e&&(e={});const t=e.partial?"*":"+";return new RegExp("(?!^|\\(|\\s)*([-]+)?([\\w.$]+)"+(e.partial?"?":"")+":"+(e.partial?"?":"")+'(?!:)([><=]*)(?:(")(.'+t+'?)(\\*)?"|([^\\s()*"]'+t+"))"+(e.partial?"?":"")+"(\\*)?(?!\\s|\\)|$)*","g")}function A(e,t,n){void 0===t&&(t=[]),void 0===n&&(n=[]);const o=Array.isArray(e)?e:O({partial:!0}).exec(e);if(!o||!o.length)return{};const s={fullToken:o[0],attributeName:o[2],attributeNameValid:!1,attributeValue:o[5]||o[7],attributeValueValid:!1,prepended:o[1]||"",operator:o[3],negated:o[0].indexOf("-")>-1,quoted:Boolean(o[4]),wildcard:Boolean(o[6]||o[8])};if(t){const e=t.find(e=>{let t=!1;for(const i of n)if(o=s.attributeName,new RegExp("^"+C.default(e[i]||"")+"$","i").test(o||"")){t=!0;break}var o;return t});e&&(s.attributeNameValid=!0,s.attributeValueValid=!0,Array.isArray(e.enumerations)&&(s.attributeValueValid=e.enumerations.findIndex(e=>P(s.attributeValue,e))>-1))}return s}const V=s.keyframes(d||(d=K(["\n  0% {\n    opacity: 0;\n    transform: perspective(50em) rotateX(-30deg);\n  }\n  100% {\n    opacity: 1;\n    transform: perspective(50em) rotateX(0deg);\n  }\n"]))),F=k.default("aside")(u||(u=K(["\n    display: inline-block;\n    position: absolute;\n    z-index: 10;\n    transform-origin: 50% 0;\n    animation: "," ease-in-out 250ms;\n    transition: top 100ms, left 100ms;\n\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),V,i.top,i.left,i.color,i.boxShadow,i.borders,i.borderColor,i.borderRadius,i.space,i.width,i.minWidth,i.fontSize,i.fontWeight,i.fontFamily,i.lineHeight,i.letterSpacing);F.defaultProps={bg:"#555555",boxShadow:"0 4px 10px rgba(0, 0, 0, .25)",color:"#FFFFFF",minWidth:"280px"};const D=k.default("section")(p||(p=K(["\n    padding: 15px;\n    text-align: ",";\n    :not(:last-child) {\n        border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n    }\n"])),e=>e.center?"center":"inherit"),I=k.default("ul")(h||(h=K(["\n    list-style-type: none;\n    line-height: 20px;\n    margin: 10px 0;\n    overflow: auto;\n    padding-inline-start: 0;\n\n    ","\n    ","\n  ","\n  ","\n"])),i.space,i.color,i.borders,i.maxHeight);I.defaultProps={maxHeight:"200px"};const j=k.default("li")(c||(c=K(["\n    cursor: pointer;\n    border: 1px solid transparent;\n    overflow: hidden;\n    text-overflow: ellipsis;\n\n    ","\n    ","\n\n  ","\n  ","\n  ","\n"])),i.space,i.maxWidth,e=>e.active&&i.color,e=>e.active&&i.borders,e=>e.active&&i.borderColor);j.defaultProps={bg:"#FFFFFF",color:"#000000",p:"3px 15px",maxWidth:"320px"};const T=k.default(D)(f||(f=K(["\n    padding: 15px 0;\n"]))),H=k.default("div")(g||(g=K(["\n    display: inline-block;\n    background: ",";\n    font-weight: 500;\n    line-height: 18px;\n    padding: 5px 10px;\n    cursor: pointer;\n    &:hover {\n        background: rgba(255, 255, 255, 0.1);\n    }\n"])),e=>e.active?"rgba(255, 255, 255, 0.2)":"none"),_=k.default(H)(b||(b=K(["\n    display: block;\n    margin-bottom: 5px;\n"]))),R=k.default("div")(m||(m=K(["\n    display: inline-block;\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 2px;\n    font-size: 12px;\n    font-weight: 700;\n    line-height: 18px;\n    min-width: 20px;\n    text-align: center;\n    vertical-align: middle;\n    padding: 2px 5px;\n    margin-right: 5px;\n"]))),L=k.default(R)(y||(y=K(["\n    background: none;\n    border: 1px solid ",";\n    color: ",";\n    font-size: 8px;\n    padding: 0;\n    width: ",";\n    height: 18px;\n"])),e=>e.theme.color,e=>e.theme.color,e=>e.long?"36px":"18px"),N=k.default("div")(v||(v=K(["\n    display: inline-block;\n    opacity: 0.5;\n    &:not(:last-child) {\n        margin-right: 15px;\n    }\n"])));class q extends e.PureComponent{constructor(e){super(e),this.onKeyDown=this.onKeyDown.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.handleEscKey=this.handleEscKey.bind(this),this.handleArrowKeys=this.handleArrowKeys.bind(this),this.adjustListScroll=this.adjustListScroll.bind(this),this.getAttribute=this.getAttribute.bind(this),this.getSuggestions=this.getSuggestions.bind(this),this.getSuggestionAddons=this.getSuggestionAddons.bind(this),this.filterSuggestions=this.filterSuggestions.bind(this),this.acceptSuggestion=this.acceptSuggestion.bind(this),this.getOperators=this.getOperators.bind(this),this.setOperator=this.setOperator.bind(this),this.state={suggestions:[],highlightedIdx:0,selectedIdx:null,prepended:"",operator:"",negated:!1}}componentDidMount(){this.filterSuggestions(this.props.value),this.props.keyboardHelpers&&document.addEventListener("keydown",this.onKeyDown,!1)}componentWillUnmount(){this.props.keyboardHelpers&&document.removeEventListener("keydown",this.onKeyDown,!1)}componentWillReceiveProps(e){this.props.value!==e.value&&this.filterSuggestions(e.value)}componentDidUpdate(){0===this.state.suggestions.length&&this.props.onClose()}onKeyDown(e){switch(e.keyCode){case 9:case 13:this.handleEnterKey(e);break;case 27:this.handleEscKey(e);break;case 38:case 40:this.handleArrowKeys(e,e.keyCode)}}handleEnterKey(e){e.preventDefault(),this.acceptSuggestion()}handleEscKey(e){e.preventDefault(),this.props.onClose(!0)}handleArrowKeys(e,t){e.preventDefault();const{highlightedIdx:n}=this.state,o=40===t,s=this.state.suggestions.length-1,i=null!==n?o?n+1:n-1:o?0:s;this.setState({highlightedIdx:o?i<=s?i:0:i>=0?i:s},this.adjustListScroll)}adjustListScroll(){const{offsetTop:e,clientHeight:t}=this._selected,{scrollTop:n,clientHeight:o}=this._list,s=t,i=o-t,r=e-n;r>i?this._list.scrollTop+=t+(r-i):r<s&&(this._list.scrollTop=e-t+(r-s))}getAttribute(e){if(null!==e&&e>-1)return this.props.attributes[e]}getSuggestions(e){const{nameKey:t,attributes:n}=this.props;return e?e.enumerations||[]:n.map(e=>e[t])}getSuggestionAddons(e,t){const n=[];return e&&(t.wildcard||e.enumerations||!t.attributeValue||"string"!==e.type||n.push('"'+t.attributeValue+'"'),t.attributeValue&&"string"===e.type&&(t.quoted&&!e.enumerations?n.push('"'+t.attributeValue+'*"'):n.push("*"+t.attributeValue+"*",t.attributeValue+"*","*"+t.attributeValue))),n}filterSuggestions(e){const{nameKey:t,attributes:n}=this.props,o=A(e),s=o.attributeName&&e.indexOf(":")>-1?n.findIndex(e=>e[t]===o.attributeName):-1,i=this.getAttribute(s),r=this.getSuggestions(i),a=s>-1?o.attributeValue:o.attributeName,l=r.filter(e=>P(a,e)).concat(this.getSuggestionAddons(i,o));this.setState({selectedIdx:s,prepended:o.prepended,operator:o.operator,negated:o.negated,suggestions:l,highlightedIdx:0})}acceptSuggestion(){const{nameKey:e,onSelect:t}=this.props,{suggestions:n,highlightedIdx:o,selectedIdx:s,prepended:i,operator:r}=this.state,a=this.getAttribute(s),l=n[o];t(""+i+(a?a[e]+":"+r+l:l),-1===s?":":"")}getOperators(){const e=[],t=this.getAttribute(this.state.selectedIdx);if(t)switch(t.type){case"int":case"float":e.push({name:"GT",char:">",active:">"===this.state.operator}),e.push({name:"LT",char:"<",active:"<"===this.state.operator}),e.push({name:"GTE",char:">=",active:">="===this.state.operator}),e.push({name:"LTE",char:"<=",active:"<="===this.state.operator})}return e}setOperator(e){const{value:t}=this.props,{negated:n,operator:o}=this.state;if("-"===e){const e=t.replace(/^-?(.*)/,(n?"":"-")+"$1");this.props.onSelect(e)}else{const n=A(t);n.operator=o===e?"":e,this.props.onSelect(function(e){const{prepended:t="",attributeName:n="",attributeValue:o="",operator:s=""}=e||{};return""+t+n+":"+s+o}(n))}}render(){const e=this.props.footerComponent;/*#__PURE__*/return w.default.createElement(F,E({left:this.props.offsetX||0,top:this.props.offsetY||0},this.props.dropdownProps,{"data-testid":"dropdown"}),/*#__PURE__*/w.default.createElement(I,E({},this.props.listProps,{ref:e=>this._list=e}),this.state.suggestions.map((e,t)=>{const n=this.state.highlightedIdx===t;/*#__PURE__*/return w.default.createElement(j,E({key:t,active:n,onClick:this.acceptSuggestion,onMouseOver:()=>this.setState({highlightedIdx:t}),ref:n?e=>this._selected=e:void 0},this.props.selectorProps),e)})),/*#__PURE__*/w.default.createElement(T,null,/*#__PURE__*/w.default.createElement(_,{active:this.state.negated,onClick:()=>this.setOperator("-")},/*#__PURE__*/w.default.createElement(R,null,"-"),this.props.translations&&this.props.translations.negate?this.props.translations.negate:"NEGATE"),this.getOperators().map((e,t)=>/*#__PURE__*/w.default.createElement(H,{key:t,active:e.active,onClick:()=>this.setOperator(e.char)},/*#__PURE__*/w.default.createElement(R,null,e.char),e.name))),this.props.keyboardHelpers&&/*#__PURE__*/w.default.createElement(D,{center:!0},/*#__PURE__*/w.default.createElement(N,null,/*#__PURE__*/w.default.createElement(L,null,"▲"),/*#__PURE__*/w.default.createElement(L,null,"▼"),this.props.translations&&this.props.translations.navigate?this.props.translations.navigate:"to navigate"),/*#__PURE__*/w.default.createElement(N,null,/*#__PURE__*/w.default.createElement(L,{long:!0},"↵"),this.props.translations&&this.props.translations.select?this.props.translations.select:"to select")),/*#__PURE__*/w.default.createElement(e,null))}}q.propTypes={value:x.default.string,nameKey:x.default.string,attributes:x.default.array,onSelect:x.default.func,onClose:x.default.func,offsetX:x.default.number,offsetY:x.default.number,keyboardHelpers:x.default.bool,footerComponent:x.default.func,dropdownProps:x.default.object,selectorProps:x.default.object,listProps:x.default.object,translations:x.default.object},q.defaultProps={value:"",nameKey:"name",onSelect:()=>{},onClose:()=>{},keyboardHelpers:!0,footerComponent:()=>null};class B extends e.Component{constructor(e){super(e),this.wrapperRef=/*#__PURE__*/w.default.createRef(),this.handleClickOutside=this.handleClickOutside.bind(this)}componentDidMount(){document.addEventListener("mousedown",this.handleClickOutside)}componentWillUnmount(){document.removeEventListener("mousedown",this.handleClickOutside)}handleClickOutside(e){this.wrapperRef&&!this.wrapperRef.current.contains(e.target)&&this.props.notify&&this.props.notify()}render(){/*#__PURE__*/return w.default.createElement("div",{ref:this.wrapperRef},this.props.children)}}var W,z,X,Y,$,M,U;const G=k.default("div")(W||(W=K(["\n    position: relative;\n    width: 100%;\n"]))),Q=k.default("div")(z||(z=K(["\n    position: relative;\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),i.space,i.width,i.borders,i.borderColor,i.borderRadius,i.boxShadow,i.color,i.fontSize,i.fontWeight,i.fontFamily,i.lineHeight,i.letterSpacing,i.textAlign);Q.defaultProps={bg:"#FFFFFF",color:"#505050",border:"1px solid rgba(0, 0, 0, .1)",fontFamily:"monospace"};const J=S.default,Z=i.style({prop:"placeholderColor",cssProperty:"color",key:"colors"}),ee=k.default(J)(X||(X=K(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    /* we only want overlay text visible */\n    /* need to do this so caret still shows up */\n    color: inherit;\n    -webkit-text-fill-color: transparent;\n    ::placeholder {\n        ","\n        -webkit-text-fill-color: initial;\n    }\n"])),Z);ee.defaultProps={lineHeight:"1.1rem",placeholderColor:"#D7D7D7"};const te=k.default("div")(Y||(Y=K(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    max-width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    pointer-events: none;\n    padding: inherit;\n\n    ","\n\n    /* reversed from Input above */\n  -webkit-text-fill-color: initial;\n"])),e=>e.collapsed&&r.css($||($=K(["\n            overflow: hidden;\n            white-space: nowrap;\n            text-overflow: ellipsis;\n        "])))),ne=k.default("span")(M||(M=K(["\n    font: inherit;\n"]))),oe=i.style({prop:"tokenColor",cssProperty:"color",key:"colors"}),se=k.default(ne)(U||(U=K(["\n    position: relative;\n    cursor: pointer;\n    font-weight: 500;\n\n    ","\n"])),oe);se.defaultProps={tokenColor:"#2384FF"};class ie extends e.Component{constructor(e){super(e),this.onFocus=this.onFocus.bind(this),this.onBlur=this.onBlur.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onChange=this.onChange.bind(this),this.onAutosuggest=this.onAutosuggest.bind(this),this.onSelectValue=this.onSelectValue.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.shouldAutosuggest=this.shouldAutosuggest.bind(this),this.onClose=this.onClose.bind(this),this.extract=this.extract.bind(this),this.getCurrentChunk=this.getCurrentChunk.bind(this),this.buildOverlay=this.buildOverlay.bind(this),this.state={focused:!1,value:e.defaultValue,attributes:e.data,overlayComponents:[],dropdownClosed:!1,dropdownOpen:!1,dropdownValue:null,dropdownX:null,dropdownY:null}}componentDidMount(){this.setState({overlayComponents:this.buildOverlay(this.state.value)})}componentDidUpdate(e,t){const{value:n,attributes:o}=this.state;n!==t.value&&this.props.onChange(n),n===t.value&&o.length===t.attributes.length||this.setState({overlayComponents:this.buildOverlay(n)},this.onAutosuggest)}componentWillReceiveProps(e){const t={};void 0!==e.defaultValue&&(t.value=e.defaultValue),e.data&&(t.attributes=e.data),this.setState(t)}onFocus(e){this.setState({focused:!0},this.onAutosuggest)}onBlur(e){this.setState({focused:!1})}onKeyDown(e){13===e.keyCode&&this.handleEnterKey(e),37!==e.keyCode&&39!==e.keyCode||this.onClose()}onChange(e){this.setState({value:e.target.value})}onAutosuggest(){const{value:e}=this.state,{offsetLeft:t,offsetTop:n}=this._marker,{chunk:o}=this.getCurrentChunk(e),s=this.shouldAutosuggest(o);this.setState(s?{dropdownClosed:!1,dropdownOpen:!0,dropdownValue:o,dropdownX:t,dropdownY:n+25}:{dropdownOpen:!1})}onSelectValue(e,t){void 0===t&&(t="");const{value:n}=this.state,{index:o,indexEnd:s}=this.getCurrentChunk(n),i=n.slice(0,o),r=n.slice(s),a=o+e.length+t.length;this.setState({value:""+i+e+t+r,dropdownClosed:":"!==t},()=>{this._input.focus(),this._input.setSelectionRange(a,a)})}handleEnterKey(e){const t=document.activeElement===this._input;e.shiftKey||!t||this.state.dropdownOpen||(e.preventDefault(),this.props.onSubmit(this.state.value),e.target.blur())}shouldAutosuggest(e){const{selectionStart:t}=this._input,{value:n,focused:o}=this.state,s=!n.charAt(t)||/[)\s]/.test(n.charAt(t)),i=s&&/[\s-(]/.test(n.charAt(t-1)),r=s&&/[^)\s]/.test(n.charAt(t-1));return o&&(!n||i||r&&!this.state.dropdownClosed)}onClose(e){this.setState({dropdownOpen:!1,dropdownClosed:e||!1})}extract(e){const{nameKeyIncludes:t}=this.props,{attributes:n}=this.state;return function(e,t,n){const o=[],s=O();let i;for(;null!==(i=s.exec(e));){if(t){const e=A(i,t,n);if(!e.attributeNameValid||!e.attributeValueValid)continue}o.push([i.index,s.lastIndex])}return o}(e,n,t)}getCurrentChunk(e){const{selectionStart:t}=this._input,n=this.extract(e),o=e.substring(0,t),s=o.match(/[^\s]*$/),i=s?o.lastIndexOf(s[s.length-1]):-1;let r=i;for(const[e,o]of n.reverse()){if(t>o&&i<e){r=o;break}if(t>e&&t<=o){r=e;break}if(i>e&&i<o){r=o;break}}const a=e.substring(r,t);return{index:r,indexEnd:r+a.length,chunk:a}}buildTokens(e,t){const n=[],o=this.extract(e);let s=0;return o.reduce((t,o)=>(n.push(e.substring(t[1],o[0])),n.push(/*#__PURE__*/w.default.createElement(se,{key:"token-"+o[0],tokenColor:this.props.inputProps.tokenColor},e.substring(o[0],o[1]))),s=o[1],o),[null,0]),n.push(e.substring(s)),n.filter(Boolean)}buildOverlay(e){const{index:t}=this.getCurrentChunk(e),n=this.buildTokens(e.substring(0,t)),o=this.buildTokens(e.substring(t)||" ",t);return[n,/*#__PURE__*/w.default.createElement(ne,{key:"after-"+t,style:{outline:this.props.debug?"1px solid red":"none"},ref:e=>this._marker=e},o)]}render(){const{nameKey:e,className:t,inputProps:n,placeholder:o,keyboardHelpers:s,collapseOnBlur:i,footerComponent:r,dropdownProps:a,selectorProps:l,listProps:d,alwaysLeft:u,translations:p}=this.props,{value:h,attributes:c,dropdownOpen:f,dropdownValue:g,dropdownX:b,dropdownY:m,overlayComponents:y}=this.state,v=!this.state.focused&&i;/*#__PURE__*/return w.default.createElement(B,{notify:this.onClose},/*#__PURE__*/w.default.createElement(G,{className:t},/*#__PURE__*/w.default.createElement(Q,E({},n,{onClick:()=>this._input.focus()}),/*#__PURE__*/w.default.createElement(te,{collapsed:v},y),/*#__PURE__*/w.default.createElement(ee,{autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",autoFocus:n.autoFocus,maxRows:v?1:void 0,placeholder:o,placeholderColor:n.placeholderColor,value:h,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onChange:this.onChange,ref:e=>this._input=e})),f&&/*#__PURE__*/w.default.createElement(q,{keyboardHelpers:s,footerComponent:r,attributes:c,value:g,nameKey:e,onSelect:this.onSelectValue,onClose:this.onClose,offsetX:u?0:b,offsetY:m,dropdownProps:a,selectorProps:l,listProps:d,translations:p})))}}ie.propTypes={debug:x.default.bool,data:x.default.array,nameKey:x.default.string,nameKeyIncludes:x.default.array,defaultValue:x.default.string,placeholder:x.default.string,onChange:x.default.func,onSubmit:x.default.func,keyboardHelpers:x.default.bool,collapseOnBlur:x.default.bool,footerComponent:x.default.func,inputProps:x.default.object,dropdownProps:x.default.object,selectorProps:x.default.object,listProps:x.default.object,alwaysLeft:x.default.bool,translations:x.default.object},ie.defaultProps={data:[],nameKey:"name",nameKeyIncludes:["name"],defaultValue:"",onChange:()=>{},onSubmit:()=>{},placeholder:"Search",inputProps:{},dropdownProps:{},selectorProps:{},listProps:{}},exports.QueryAssist=ie;
//# sourceMappingURL=lib.js.map
