var t=require("react"),e=require("prop-types"),n=require("escape-string-regexp"),o=require("@emotion/styled"),s=require("@emotion/react"),i=require("styled-system"),r=require("@emotion/css"),a=require("react-textarea-autosize");function l(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var d,u,p,h,c,f,g,b,m,y,v,w=/*#__PURE__*/l(t),x=/*#__PURE__*/l(e),C=/*#__PURE__*/l(n),k=/*#__PURE__*/l(o),S=/*#__PURE__*/l(a);function E(){return E=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},E.apply(this,arguments)}function K(t,e){return e||(e=t.slice(0)),t.raw=e,t}function P(t,e){return new RegExp(C.default(t||""),"i").test(e||"")}function O(t){void 0===t&&(t={});const e=t.partial?"*":"+";return new RegExp("(?!^|\\(|\\s)*([-]+)?([\\w.$]+)"+(t.partial?"?":"")+":"+(t.partial?"?":"")+'(?!:)([><=]*)(?:(")(.'+e+'?)(\\*)?"|([^\\s()*"]'+e+"))"+(t.partial?"?":"")+"(\\*)?(?!\\s|\\)|$)*","g")}function A(t,e,n){void 0===e&&(e=[]),void 0===n&&(n=[]);const o=Array.isArray(t)?t:O({partial:!0}).exec(t);if(!o||!o.length)return{};const s={fullToken:o[0],attributeName:o[2],attributeNameValid:!1,attributeValue:o[5]||o[7],attributeValueValid:!1,prepended:o[1]||"",operator:o[3],negated:o[0].indexOf("-")>-1,quoted:Boolean(o[4]),wildcard:Boolean(o[6]||o[8])};if(e){const t=e.find(t=>{let e=!1;for(const i of n)if(o=s.attributeName,new RegExp("^"+C.default(t[i]||"")+"$","i").test(o||"")){e=!0;break}var o;return e});t&&(s.attributeNameValid=!0,s.attributeValueValid=!0,Array.isArray(t.enumerations)&&(s.attributeValueValid=t.enumerations.findIndex(t=>P(s.attributeValue,t))>-1))}return s}const V=s.keyframes(d||(d=K(["\n  0% {\n    opacity: 0;\n    transform: perspective(50em) rotateX(-30deg);\n  }\n  100% {\n    opacity: 1;\n    transform: perspective(50em) rotateX(0deg);\n  }\n"]))),F=k.default("aside")(u||(u=K(["\n    display: inline-block;\n    position: absolute;\n    z-index: 10;\n    transform-origin: 50% 0;\n    animation: "," ease-in-out 250ms;\n    transition: top 100ms, left 100ms;\n\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),V,i.top,i.left,i.color,i.boxShadow,i.borders,i.borderColor,i.borderRadius,i.space,i.width,i.minWidth,i.fontSize,i.fontWeight,i.fontFamily,i.lineHeight,i.letterSpacing);F.defaultProps={bg:"#555555",boxShadow:"0 4px 10px rgba(0, 0, 0, .25)",color:"#FFFFFF",minWidth:"280px"};const D=k.default("section")(p||(p=K(["\n    padding: 15px;\n    text-align: ",";\n    :not(:last-child) {\n        border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n    }\n"])),t=>t.center?"center":"inherit"),I=k.default("ul")(h||(h=K(["\n    list-style-type: none;\n    line-height: 20px;\n    margin: 10px 0;\n    overflow: auto;\n    padding-inline-start: 0;\n\n    ","\n    ","\n  ","\n  ","\n"])),i.space,i.color,i.borders,i.maxHeight);I.defaultProps={maxHeight:"200px"};const j=k.default("li")(c||(c=K(["\n    cursor: pointer;\n    border: 1px solid transparent;\n    overflow: hidden;\n    text-overflow: ellipsis;\n\n    ","\n    ","\n\n  ","\n  ","\n  ","\n"])),i.space,i.maxWidth,t=>t.active&&i.color,t=>t.active&&i.borders,t=>t.active&&i.borderColor);j.defaultProps={bg:"#FFFFFF",color:"#000000",p:"3px 15px",maxWidth:"320px"};const T=k.default(D)(f||(f=K(["\n    padding: 15px 0;\n"]))),H=k.default("div")(g||(g=K(["\n    display: inline-block;\n    background: ",";\n    font-weight: 500;\n    line-height: 18px;\n    padding: 5px 10px;\n    cursor: pointer;\n    &:hover {\n        background: rgba(255, 255, 255, 0.1);\n    }\n"])),t=>t.active?"rgba(255, 255, 255, 0.2)":"none"),_=k.default(H)(b||(b=K(["\n    display: block;\n    margin-bottom: 5px;\n"]))),R=k.default("div")(m||(m=K(["\n    display: inline-block;\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 2px;\n    font-size: 12px;\n    font-weight: 700;\n    line-height: 18px;\n    min-width: 20px;\n    text-align: center;\n    vertical-align: middle;\n    padding: 2px 5px;\n    margin-right: 5px;\n"]))),L=k.default(R)(y||(y=K(["\n    background: none;\n    border: 1px solid ",";\n    color: ",";\n    font-size: 8px;\n    padding: 0;\n    width: ",";\n    height: 18px;\n"])),t=>t.theme.color,t=>t.theme.color,t=>t.long?"36px":"18px"),N=k.default("div")(v||(v=K(["\n    display: inline-block;\n    opacity: 0.5;\n    &:not(:last-child) {\n        margin-right: 15px;\n    }\n"])));class q extends t.PureComponent{constructor(t){super(t),this.onKeyDown=this.onKeyDown.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.handleEscKey=this.handleEscKey.bind(this),this.handleArrowKeys=this.handleArrowKeys.bind(this),this.adjustListScroll=this.adjustListScroll.bind(this),this.getAttribute=this.getAttribute.bind(this),this.getSuggestions=this.getSuggestions.bind(this),this.getSuggestionAddons=this.getSuggestionAddons.bind(this),this.filterSuggestions=this.filterSuggestions.bind(this),this.acceptSuggestion=this.acceptSuggestion.bind(this),this.getOperators=this.getOperators.bind(this),this.setOperator=this.setOperator.bind(this),this.state={suggestions:[],highlightedIdx:0,selectedIdx:null,prepended:"",operator:"",negated:!1}}componentDidMount(){this.filterSuggestions(this.props.value),this.props.keyboardHelpers&&document.addEventListener("keydown",this.onKeyDown,!1)}componentWillUnmount(){this.props.keyboardHelpers&&document.removeEventListener("keydown",this.onKeyDown,!1)}componentWillReceiveProps(t){this.props.value!==t.value&&this.filterSuggestions(t.value)}componentDidUpdate(){0===this.state.suggestions.length&&this.props.onClose()}onKeyDown(t){switch(t.keyCode){case 9:case 13:this.handleEnterKey(t);break;case 27:this.handleEscKey(t);break;case 38:case 40:this.handleArrowKeys(t,t.keyCode)}}handleEnterKey(t){t.preventDefault(),this.acceptSuggestion()}handleEscKey(t){t.preventDefault(),this.props.onClose(!0)}handleArrowKeys(t,e){t.preventDefault();const{highlightedIdx:n}=this.state,o=40===e,s=this.state.suggestions.length-1,i=null!==n?o?n+1:n-1:o?0:s;this.setState({highlightedIdx:o?i<=s?i:0:i>=0?i:s},this.adjustListScroll)}adjustListScroll(){const{offsetTop:t,clientHeight:e}=this._selected,{scrollTop:n,clientHeight:o}=this._list,s=e,i=o-e,r=t-n;r>i?this._list.scrollTop+=e+(r-i):r<s&&(this._list.scrollTop=t-e+(r-s))}getAttribute(t){if(null!==t&&t>-1)return this.props.attributes[t]}getSuggestions(t){const{nameKey:e,attributes:n,translationKey:o}=this.props;return t?t.enumerations||[]:n.map(t=>t[o]||t[e])}getSuggestionAddons(t,e){const n=[];return t&&(e.wildcard||t.enumerations||!e.attributeValue||"string"!==t.type||n.push('"'+e.attributeValue+'"'),e.attributeValue&&"string"===t.type&&(e.quoted&&!t.enumerations?n.push('"'+e.attributeValue+'*"'):n.push("*"+e.attributeValue+"*",e.attributeValue+"*","*"+e.attributeValue))),n}filterSuggestions(t){const{nameKey:e,translationKey:n,attributes:o}=this.props;let s=A(t);const i=s.attributeName&&t.indexOf(":")>-1?o.findIndex(t=>t[e]===s.attributeName||t[n]===s.attributeName):-1,r=this.getAttribute(i),a=this.getSuggestions(r),l=i>-1?s.attributeValue:s.attributeName,d=a.filter(t=>P(l,t)).concat(this.getSuggestionAddons(r,s));this.setState({selectedIdx:i,prepended:s.prepended,operator:s.operator,negated:s.negated,suggestions:d,highlightedIdx:0})}acceptSuggestion(){const{nameKey:t,onSelect:e}=this.props,{suggestions:n,highlightedIdx:o,selectedIdx:s,prepended:i,operator:r}=this.state,a=this.getAttribute(s),l=n[o];e(""+i+(a?a[t]+":"+r+l:l),-1===s?":":"")}getOperators(){const t=[],e=this.getAttribute(this.state.selectedIdx);if(e)switch(e.type){case"int":case"float":t.push({name:"GT",char:">",active:">"===this.state.operator}),t.push({name:"LT",char:"<",active:"<"===this.state.operator}),t.push({name:"GTE",char:">=",active:">="===this.state.operator}),t.push({name:"LTE",char:"<=",active:"<="===this.state.operator})}return t}setOperator(t){const{value:e}=this.props,{negated:n,operator:o}=this.state;if("-"===t){const t=e.replace(/^-?(.*)/,(n?"":"-")+"$1");this.props.onSelect(t)}else{const n=A(e);n.operator=o===t?"":t,this.props.onSelect(function(t){const{prepended:e="",attributeName:n="",attributeValue:o="",operator:s=""}=t||{};return""+e+n+":"+s+o}(n))}}render(){const t=this.props.footerComponent;/*#__PURE__*/return w.default.createElement(F,E({left:this.props.offsetX||0,top:this.props.offsetY||0},this.props.dropdownProps,{"data-testid":"dropdown"}),/*#__PURE__*/w.default.createElement(I,E({},this.props.listProps,{ref:t=>this._list=t}),this.state.suggestions.map((t,e)=>{const n=this.state.highlightedIdx===e;/*#__PURE__*/return w.default.createElement(j,E({key:e,active:n,onClick:this.acceptSuggestion,onMouseOver:()=>this.setState({highlightedIdx:e}),ref:n?t=>this._selected=t:void 0},this.props.selectorProps),t)})),/*#__PURE__*/w.default.createElement(T,null,/*#__PURE__*/w.default.createElement(_,{active:this.state.negated,onClick:()=>this.setOperator("-")},/*#__PURE__*/w.default.createElement(R,null,"-"),this.props.translations&&this.props.translations.negate?this.props.translations.negate:"NEGATE"),this.getOperators().map((t,e)=>/*#__PURE__*/w.default.createElement(H,{key:e,active:t.active,onClick:()=>this.setOperator(t.char)},/*#__PURE__*/w.default.createElement(R,null,t.char),t.name))),this.props.keyboardHelpers&&/*#__PURE__*/w.default.createElement(D,{center:!0},/*#__PURE__*/w.default.createElement(N,null,/*#__PURE__*/w.default.createElement(L,null,"▲"),/*#__PURE__*/w.default.createElement(L,null,"▼"),this.props.translations&&this.props.translations.navigate?this.props.translations.navigate:"to navigate"),/*#__PURE__*/w.default.createElement(N,null,/*#__PURE__*/w.default.createElement(L,{long:!0},"↵"),this.props.translations&&this.props.translations.select?this.props.translations.select:"to select")),/*#__PURE__*/w.default.createElement(t,null))}}q.propTypes={value:x.default.string,nameKey:x.default.string,attributes:x.default.array,onSelect:x.default.func,onClose:x.default.func,offsetX:x.default.number,offsetY:x.default.number,keyboardHelpers:x.default.bool,footerComponent:x.default.func,dropdownProps:x.default.object,selectorProps:x.default.object,listProps:x.default.object,translations:x.default.object},q.defaultProps={value:"",nameKey:"name",translationKey:"translation",onSelect:()=>{},onClose:()=>{},keyboardHelpers:!0,footerComponent:()=>null};class B extends t.Component{constructor(t){super(t),this.wrapperRef=/*#__PURE__*/w.default.createRef(),this.handleClickOutside=this.handleClickOutside.bind(this)}componentDidMount(){document.addEventListener("mousedown",this.handleClickOutside)}componentWillUnmount(){document.removeEventListener("mousedown",this.handleClickOutside)}handleClickOutside(t){this.wrapperRef&&!this.wrapperRef.current.contains(t.target)&&this.props.notify&&this.props.notify()}render(){/*#__PURE__*/return w.default.createElement("div",{ref:this.wrapperRef},this.props.children)}}var W,z,X,Y,$,M,U;const G=k.default("div")(W||(W=K(["\n    position: relative;\n    width: 100%;\n"]))),Q=k.default("div")(z||(z=K(["\n    position: relative;\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),i.space,i.width,i.borders,i.borderColor,i.borderRadius,i.boxShadow,i.color,i.fontSize,i.fontWeight,i.fontFamily,i.lineHeight,i.letterSpacing,i.textAlign);Q.defaultProps={bg:"#FFFFFF",color:"#505050",border:"1px solid rgba(0, 0, 0, .1)",fontFamily:"monospace"};const J=S.default,Z=i.style({prop:"placeholderColor",cssProperty:"color",key:"colors"}),tt=k.default(J)(X||(X=K(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    /* we only want overlay text visible */\n    /* need to do this so caret still shows up */\n    color: inherit;\n    -webkit-text-fill-color: transparent;\n    ::placeholder {\n        ","\n        -webkit-text-fill-color: initial;\n    }\n"])),Z);tt.defaultProps={lineHeight:"1.1rem",placeholderColor:"#D7D7D7"};const et=k.default("div")(Y||(Y=K(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    max-width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    pointer-events: none;\n    padding: inherit;\n\n    ","\n\n    /* reversed from Input above */\n  -webkit-text-fill-color: initial;\n"])),t=>t.collapsed&&r.css($||($=K(["\n            overflow: hidden;\n            white-space: nowrap;\n            text-overflow: ellipsis;\n        "])))),nt=k.default("span")(M||(M=K(["\n    font: inherit;\n"]))),ot=i.style({prop:"tokenColor",cssProperty:"color",key:"colors"}),st=k.default(nt)(U||(U=K(["\n    position: relative;\n    cursor: pointer;\n    font-weight: 500;\n\n    ","\n"])),ot);st.defaultProps={tokenColor:"#2384FF"};class it extends t.Component{constructor(t){super(t),this.onFocus=this.onFocus.bind(this),this.onBlur=this.onBlur.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onChange=this.onChange.bind(this),this.onAutosuggest=this.onAutosuggest.bind(this),this.onSelectValue=this.onSelectValue.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.shouldAutosuggest=this.shouldAutosuggest.bind(this),this.onClose=this.onClose.bind(this),this.extract=this.extract.bind(this),this.getCurrentChunk=this.getCurrentChunk.bind(this),this.buildOverlay=this.buildOverlay.bind(this),this.state={focused:!1,value:t.defaultValue,attributes:t.data,overlayComponents:[],dropdownClosed:!1,dropdownOpen:!1,dropdownValue:null,dropdownX:null,dropdownY:null}}componentDidMount(){this.setState({overlayComponents:this.buildOverlay(this.state.value)})}componentDidUpdate(t,e){const{value:n,attributes:o}=this.state;n!==e.value&&this.props.onChange(n),n===e.value&&o.length===e.attributes.length||this.setState({overlayComponents:this.buildOverlay(n)},this.onAutosuggest)}componentWillReceiveProps(t){const e={};void 0!==t.defaultValue&&(e.value=t.defaultValue),t.data&&(e.attributes=t.data),this.setState(e)}onFocus(t){this.setState({focused:!0},this.onAutosuggest)}onBlur(t){this.setState({focused:!1})}onKeyDown(t){13===t.keyCode&&this.handleEnterKey(t),37!==t.keyCode&&39!==t.keyCode||this.onClose()}onChange(t){this.setState({value:t.target.value})}onAutosuggest(){const{value:t}=this.state,{offsetLeft:e,offsetTop:n}=this._marker,{chunk:o}=this.getCurrentChunk(t),s=this.shouldAutosuggest(o);this.setState(s?{dropdownClosed:!1,dropdownOpen:!0,dropdownValue:o,dropdownX:e,dropdownY:n+25}:{dropdownOpen:!1})}onSelectValue(t,e){void 0===e&&(e="");const{value:n}=this.state,{index:o,indexEnd:s}=this.getCurrentChunk(n),i=n.slice(0,o),r=n.slice(s),a=o+t.length+e.length;this.setState({value:""+i+t+e+r,dropdownClosed:":"!==e},()=>{this._input.focus(),this._input.setSelectionRange(a,a)})}handleEnterKey(t){const e=document.activeElement===this._input;t.shiftKey||!e||this.state.dropdownOpen||(t.preventDefault(),this.props.onSubmit(this.state.value),t.target.blur())}shouldAutosuggest(t){const{selectionStart:e}=this._input,{value:n,focused:o}=this.state,s=!n.charAt(e)||/[)\s]/.test(n.charAt(e)),i=s&&/[\s-(]/.test(n.charAt(e-1)),r=s&&/[^)\s]/.test(n.charAt(e-1));return o&&(!n||i||r&&!this.state.dropdownClosed)}onClose(t){this.setState({dropdownOpen:!1,dropdownClosed:t||!1})}extract(t){const{nameKeyIncludes:e}=this.props,{attributes:n}=this.state;return function(t,e,n){const o=[],s=O();let i;for(;null!==(i=s.exec(t));){if(e){const t=A(i,e,n);if(!t.attributeNameValid||!t.attributeValueValid)continue}o.push([i.index,s.lastIndex])}return o}(t,n,e)}getCurrentChunk(t){const{selectionStart:e}=this._input,n=this.extract(t),o=t.substring(0,e),s=o.match(/[^\s]*$/),i=s?o.lastIndexOf(s[s.length-1]):-1;let r=i;for(const[t,o]of n.reverse()){if(e>o&&i<t){r=o;break}if(e>t&&e<=o){r=t;break}if(i>t&&i<o){r=o;break}}const a=t.substring(r,e);return{index:r,indexEnd:r+a.length,chunk:a}}buildTokens(t,e){const n=[],o=this.extract(t);let s=0;return o.reduce((e,o)=>(n.push(t.substring(e[1],o[0])),n.push(/*#__PURE__*/w.default.createElement(st,{key:"token-"+o[0],tokenColor:this.props.inputProps.tokenColor},t.substring(o[0],o[1]))),s=o[1],o),[null,0]),n.push(t.substring(s)),n.filter(Boolean)}buildOverlay(t){const{index:e}=this.getCurrentChunk(t),n=this.buildTokens(t.substring(0,e)),o=this.buildTokens(t.substring(e)||" ",e);return[n,/*#__PURE__*/w.default.createElement(nt,{key:"after-"+e,style:{outline:this.props.debug?"1px solid red":"none"},ref:t=>this._marker=t},o)]}render(){const{nameKey:t,className:e,inputProps:n,placeholder:o,keyboardHelpers:s,collapseOnBlur:i,footerComponent:r,dropdownProps:a,selectorProps:l,listProps:d,alwaysLeft:u,translations:p}=this.props,{value:h,attributes:c,dropdownOpen:f,dropdownValue:g,dropdownX:b,dropdownY:m,overlayComponents:y}=this.state,v=!this.state.focused&&i;/*#__PURE__*/return w.default.createElement(B,{notify:this.onClose},/*#__PURE__*/w.default.createElement(G,{className:e},/*#__PURE__*/w.default.createElement(Q,E({},n,{onClick:()=>this._input.focus()}),/*#__PURE__*/w.default.createElement(et,{collapsed:v},y),/*#__PURE__*/w.default.createElement(tt,{autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",autoFocus:n.autoFocus,maxRows:v?1:void 0,placeholder:o,placeholderColor:n.placeholderColor,value:h,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onChange:this.onChange,ref:t=>this._input=t})),f&&/*#__PURE__*/w.default.createElement(q,{keyboardHelpers:s,footerComponent:r,attributes:c,value:g,nameKey:t,onSelect:this.onSelectValue,onClose:this.onClose,offsetX:u?0:b,offsetY:m,dropdownProps:a,selectorProps:l,listProps:d,translations:p})))}}it.propTypes={debug:x.default.bool,data:x.default.array,nameKey:x.default.string,nameKeyIncludes:x.default.array,defaultValue:x.default.string,placeholder:x.default.string,onChange:x.default.func,onSubmit:x.default.func,keyboardHelpers:x.default.bool,collapseOnBlur:x.default.bool,footerComponent:x.default.func,inputProps:x.default.object,dropdownProps:x.default.object,selectorProps:x.default.object,listProps:x.default.object,alwaysLeft:x.default.bool,translations:x.default.object},it.defaultProps={data:[],nameKey:"name",nameKeyIncludes:["name"],defaultValue:"",onChange:()=>{},onSubmit:()=>{},placeholder:"Search",inputProps:{},dropdownProps:{},selectorProps:{},listProps:{}},exports.QueryAssist=it;
//# sourceMappingURL=lib.js.map
