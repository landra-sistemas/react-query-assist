import t,{PureComponent as e,Component as n}from"react";import s from"prop-types";import o from"escape-string-regexp";import i from"@emotion/styled";import{keyframes as r}from"@emotion/react";import{top as a,left as l,color as p,boxShadow as d,borders as h,borderColor as u,borderRadius as c,space as g,width as b,minWidth as f,fontSize as m,fontWeight as y,fontFamily as v,lineHeight as w,letterSpacing as x,maxHeight as k,maxWidth as C,textAlign as S,style as E}from"styled-system";import{css as K}from"@emotion/css";import O from"react-textarea-autosize";function P(){return P=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},P.apply(this,arguments)}function V(t,e){return e||(e=t.slice(0)),t.raw=e,t}function A(t,e){return new RegExp(o(t||""),"i").test(e||"")}function F(t){void 0===t&&(t={});const e=t.partial?"*":"+";return new RegExp("(?!^|\\(|\\s)*([-]+)?([\\w.$]+)"+(t.partial?"?":"")+":"+(t.partial?"?":"")+'(?!:)([><=]*)(?:(")(.'+e+'?)(\\*)?"|([^\\s()*"]'+e+"))"+(t.partial?"?":"")+"(\\*)?(?!\\s|\\)|$)*","g")}function D(t,e,n){void 0===e&&(e=[]),void 0===n&&(n=[]);const s=Array.isArray(t)?t:F({partial:!0}).exec(t);if(!s||!s.length)return{};const i={fullToken:s[0],attributeName:s[2],attributeNameValid:!1,attributeValue:s[5]||s[7],attributeValueValid:!1,prepended:s[1]||"",operator:s[3],negated:s[0].indexOf("-")>-1,quoted:Boolean(s[4]),wildcard:Boolean(s[6]||s[8])};if(e){const t=e.find(t=>{let e=!1;for(const r of n)if(s=i.attributeName,new RegExp("^"+o(t[r]||"")+"$","i").test(s||"")){e=!0;break}var s;return e});t&&(i.attributeNameValid=!0,i.attributeValueValid=!0,Array.isArray(t.enumerations)&&(i.attributeValueValid=t.enumerations.findIndex(t=>A(i.attributeValue,t))>-1))}return i}var I,j,T,_,L,H,N,R,B,X,z;const W=r(I||(I=V(["\n  0% {\n    opacity: 0;\n    transform: perspective(50em) rotateX(-30deg);\n  }\n  100% {\n    opacity: 1;\n    transform: perspective(50em) rotateX(0deg);\n  }\n"]))),Y=i("aside")(j||(j=V(["\n    display: inline-block;\n    position: absolute;\n    z-index: 10;\n    transform-origin: 50% 0;\n    animation: "," ease-in-out 250ms;\n    transition: top 100ms, left 100ms;\n\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),W,a,l,p,d,h,u,c,g,b,f,m,y,v,w,x);Y.defaultProps={bg:"#555555",boxShadow:"0 4px 10px rgba(0, 0, 0, .25)",color:"#FFFFFF",minWidth:"280px"};const $=i("section")(T||(T=V(["\n    padding: 15px;\n    text-align: ",";\n    :not(:last-child) {\n        border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n    }\n"])),t=>t.center?"center":"inherit"),M=i("ul")(_||(_=V(["\n    list-style-type: none;\n    line-height: 20px;\n    margin: 10px 0;\n    overflow: auto;\n    padding-inline-start: 0;\n\n    ","\n    ","\n  ","\n  ","\n"])),g,p,h,k);M.defaultProps={maxHeight:"200px"};const U=i("li")(L||(L=V(["\n    cursor: pointer;\n    border: 1px solid transparent;\n    overflow: hidden;\n    text-overflow: ellipsis;\n\n    ","\n    ","\n\n  ","\n  ","\n  ","\n"])),g,C,t=>t.active&&p,t=>t.active&&h,t=>t.active&&u);U.defaultProps={bg:"#FFFFFF",color:"#000000",p:"3px 15px",maxWidth:"320px"};const G=i($)(H||(H=V(["\n    padding: 15px 0;\n"]))),q=i("div")(N||(N=V(["\n    display: inline-block;\n    background: ",";\n    font-weight: 500;\n    line-height: 18px;\n    padding: 5px 10px;\n    cursor: pointer;\n    &:hover {\n        background: rgba(255, 255, 255, 0.1);\n    }\n"])),t=>t.active?"rgba(255, 255, 255, 0.2)":"none"),J=i(q)(R||(R=V(["\n    display: block;\n    margin-bottom: 5px;\n"]))),Q=i("div")(B||(B=V(["\n    display: inline-block;\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 2px;\n    font-size: 12px;\n    font-weight: 700;\n    line-height: 18px;\n    min-width: 20px;\n    text-align: center;\n    vertical-align: middle;\n    padding: 2px 5px;\n    margin-right: 5px;\n"]))),Z=i(Q)(X||(X=V(["\n    background: none;\n    border: 1px solid ",";\n    color: ",";\n    font-size: 8px;\n    padding: 0;\n    width: ",";\n    height: 18px;\n"])),t=>t.theme.color,t=>t.theme.color,t=>t.long?"36px":"18px"),tt=i("div")(z||(z=V(["\n    display: inline-block;\n    opacity: 0.5;\n    &:not(:last-child) {\n        margin-right: 15px;\n    }\n"])));class et extends e{constructor(t){super(t),this.onKeyDown=this.onKeyDown.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.handleEscKey=this.handleEscKey.bind(this),this.handleArrowKeys=this.handleArrowKeys.bind(this),this.adjustListScroll=this.adjustListScroll.bind(this),this.getAttribute=this.getAttribute.bind(this),this.getSuggestions=this.getSuggestions.bind(this),this.getSuggestionAddons=this.getSuggestionAddons.bind(this),this.filterSuggestions=this.filterSuggestions.bind(this),this.acceptSuggestion=this.acceptSuggestion.bind(this),this.getOperators=this.getOperators.bind(this),this.setOperator=this.setOperator.bind(this),this.state={suggestions:[],highlightedIdx:0,selectedIdx:null,prepended:"",operator:"",negated:!1}}componentDidMount(){this.filterSuggestions(this.props.value),this.props.keyboardHelpers&&document.addEventListener("keydown",this.onKeyDown,!1)}componentWillUnmount(){this.props.keyboardHelpers&&document.removeEventListener("keydown",this.onKeyDown,!1)}componentWillReceiveProps(t){this.props.value!==t.value&&this.filterSuggestions(t.value)}componentDidUpdate(){0===this.state.suggestions.length&&this.props.onClose()}onKeyDown(t){switch(t.keyCode){case 9:case 13:this.handleEnterKey(t);break;case 27:this.handleEscKey(t);break;case 38:case 40:this.handleArrowKeys(t,t.keyCode)}}handleEnterKey(t){t.preventDefault(),this.acceptSuggestion()}handleEscKey(t){t.preventDefault(),this.props.onClose(!0)}handleArrowKeys(t,e){t.preventDefault();const{highlightedIdx:n}=this.state,s=40===e,o=this.state.suggestions.length-1,i=null!==n?s?n+1:n-1:s?0:o;this.setState({highlightedIdx:s?i<=o?i:0:i>=0?i:o},this.adjustListScroll)}adjustListScroll(){const{offsetTop:t,clientHeight:e}=this._selected,{scrollTop:n,clientHeight:s}=this._list,o=e,i=s-e,r=t-n;r>i?this._list.scrollTop+=e+(r-i):r<o&&(this._list.scrollTop=t-e+(r-o))}getAttribute(t){if(null!==t&&t>-1)return this.props.attributes[t]}getSuggestions(t){const{nameKey:e,attributes:n}=this.props;return t?t.enumerations||[]:n.map(t=>t[e])}getSuggestionAddons(t,e){const n=[];return t&&(e.wildcard||t.enumerations||!e.attributeValue||"string"!==t.type||n.push('"'+e.attributeValue+'"'),e.attributeValue&&"string"===t.type&&(e.quoted&&!t.enumerations?n.push('"'+e.attributeValue+'*"'):n.push("*"+e.attributeValue+"*",e.attributeValue+"*","*"+e.attributeValue))),n}filterSuggestions(t){const{nameKey:e,attributes:n}=this.props,s=D(t),o=s.attributeName&&t.indexOf(":")>-1?n.findIndex(t=>t[e]===s.attributeName):-1,i=this.getAttribute(o),r=this.getSuggestions(i),a=o>-1?s.attributeValue:s.attributeName,l=r.filter(t=>A(a,t)).concat(this.getSuggestionAddons(i,s));this.setState({selectedIdx:o,prepended:s.prepended,operator:s.operator,negated:s.negated,suggestions:l,highlightedIdx:0})}acceptSuggestion(){const{nameKey:t,onSelect:e}=this.props,{suggestions:n,highlightedIdx:s,selectedIdx:o,prepended:i,operator:r}=this.state,a=this.getAttribute(o),l=n[s];e(""+i+(a?a[t]+":"+r+l:l),-1===o?":":"")}getOperators(){const t=[],e=this.getAttribute(this.state.selectedIdx);if(e)switch(e.type){case"int":case"float":t.push({name:"GT",char:">",active:">"===this.state.operator}),t.push({name:"LT",char:"<",active:"<"===this.state.operator}),t.push({name:"GTE",char:">=",active:">="===this.state.operator}),t.push({name:"LTE",char:"<=",active:"<="===this.state.operator})}return t}setOperator(t){const{value:e}=this.props,{negated:n,operator:s}=this.state;if("-"===t){const t=e.replace(/^-?(.*)/,(n?"":"-")+"$1");this.props.onSelect(t)}else{const n=D(e);n.operator=s===t?"":t,this.props.onSelect(function(t){const{prepended:e="",attributeName:n="",attributeValue:s="",operator:o=""}=t||{};return""+e+n+":"+o+s}(n))}}render(){const e=this.props.footerComponent;/*#__PURE__*/return t.createElement(Y,P({left:this.props.offsetX||0,top:this.props.offsetY||0},this.props.dropdownProps,{"data-testid":"dropdown"}),/*#__PURE__*/t.createElement(M,P({},this.props.listProps,{ref:t=>this._list=t}),this.state.suggestions.map((e,n)=>{const s=this.state.highlightedIdx===n;/*#__PURE__*/return t.createElement(U,P({key:n,active:s,onClick:this.acceptSuggestion,onMouseOver:()=>this.setState({highlightedIdx:n}),ref:s?t=>this._selected=t:void 0},this.props.selectorProps),e)})),/*#__PURE__*/t.createElement(G,null,/*#__PURE__*/t.createElement(J,{active:this.state.negated,onClick:()=>this.setOperator("-")},/*#__PURE__*/t.createElement(Q,null,"-"),this.props.translations&&this.props.translations.negate?this.props.translations.negate:"NEGATE"),this.getOperators().map((e,n)=>/*#__PURE__*/t.createElement(q,{key:n,active:e.active,onClick:()=>this.setOperator(e.char)},/*#__PURE__*/t.createElement(Q,null,e.char),e.name))),this.props.keyboardHelpers&&/*#__PURE__*/t.createElement($,{center:!0},/*#__PURE__*/t.createElement(tt,null,/*#__PURE__*/t.createElement(Z,null,"▲"),/*#__PURE__*/t.createElement(Z,null,"▼"),this.props.translations&&this.props.translations.navigate?this.props.translations.navigate:"to navigate"),/*#__PURE__*/t.createElement(tt,null,/*#__PURE__*/t.createElement(Z,{long:!0},"↵"),this.props.translations&&this.props.translations.select?this.props.translations.select:"to select")),/*#__PURE__*/t.createElement(e,null))}}et.propTypes={value:s.string,nameKey:s.string,attributes:s.array,onSelect:s.func,onClose:s.func,offsetX:s.number,offsetY:s.number,keyboardHelpers:s.bool,footerComponent:s.func,dropdownProps:s.object,selectorProps:s.object,listProps:s.object,translations:s.object},et.defaultProps={value:"",nameKey:"name",onSelect:()=>{},onClose:()=>{},keyboardHelpers:!0,footerComponent:()=>null};class nt extends n{constructor(e){super(e),this.wrapperRef=/*#__PURE__*/t.createRef(),this.handleClickOutside=this.handleClickOutside.bind(this)}componentDidMount(){document.addEventListener("mousedown",this.handleClickOutside)}componentWillUnmount(){document.removeEventListener("mousedown",this.handleClickOutside)}handleClickOutside(t){this.wrapperRef&&!this.wrapperRef.current.contains(t.target)&&this.props.notify&&this.props.notify()}render(){/*#__PURE__*/return t.createElement("div",{ref:this.wrapperRef},this.props.children)}}var st,ot,it,rt,at,lt,pt;const dt=i("div")(st||(st=V(["\n    position: relative;\n    width: 100%;\n"]))),ht=i("div")(ot||(ot=V(["\n    position: relative;\n    ","\n    ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),g,b,h,u,c,d,p,m,y,v,w,x,S);ht.defaultProps={bg:"#FFFFFF",color:"#505050",border:"1px solid rgba(0, 0, 0, .1)",fontFamily:"monospace"};const ut=O,ct=E({prop:"placeholderColor",cssProperty:"color",key:"colors"}),gt=i(ut)(it||(it=V(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    /* we only want overlay text visible */\n    /* need to do this so caret still shows up */\n    color: inherit;\n    -webkit-text-fill-color: transparent;\n    ::placeholder {\n        ","\n        -webkit-text-fill-color: initial;\n    }\n"])),ct);gt.defaultProps={lineHeight:"1.1rem",placeholderColor:"#D7D7D7"};const bt=i("div")(rt||(rt=V(["\n    display: block;\n    background: none;\n    border: none;\n    outline: none;\n    resize: none;\n    font: inherit;\n    max-width: 100%;\n    padding: 0;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    pointer-events: none;\n    padding: inherit;\n\n    ","\n\n    /* reversed from Input above */\n  -webkit-text-fill-color: initial;\n"])),t=>t.collapsed&&K(at||(at=V(["\n            overflow: hidden;\n            white-space: nowrap;\n            text-overflow: ellipsis;\n        "])))),ft=i("span")(lt||(lt=V(["\n    font: inherit;\n"]))),mt=E({prop:"tokenColor",cssProperty:"color",key:"colors"}),yt=i(ft)(pt||(pt=V(["\n    position: relative;\n    cursor: pointer;\n    font-weight: 500;\n\n    ","\n"])),mt);yt.defaultProps={tokenColor:"#2384FF"};class vt extends n{constructor(t){super(t),this.onFocus=this.onFocus.bind(this),this.onBlur=this.onBlur.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onChange=this.onChange.bind(this),this.onAutosuggest=this.onAutosuggest.bind(this),this.onSelectValue=this.onSelectValue.bind(this),this.handleEnterKey=this.handleEnterKey.bind(this),this.shouldAutosuggest=this.shouldAutosuggest.bind(this),this.onClose=this.onClose.bind(this),this.extract=this.extract.bind(this),this.getCurrentChunk=this.getCurrentChunk.bind(this),this.buildOverlay=this.buildOverlay.bind(this),this.state={focused:!1,value:t.defaultValue,attributes:t.data,overlayComponents:[],dropdownClosed:!1,dropdownOpen:!1,dropdownValue:null,dropdownX:null,dropdownY:null}}componentDidMount(){this.setState({overlayComponents:this.buildOverlay(this.state.value)})}componentDidUpdate(t,e){const{value:n,attributes:s}=this.state;n!==e.value&&this.props.onChange(n),n===e.value&&s.length===e.attributes.length||this.setState({overlayComponents:this.buildOverlay(n)},this.onAutosuggest)}componentWillReceiveProps(t){const e={};void 0!==t.defaultValue&&(e.value=t.defaultValue),t.data&&(e.attributes=t.data),this.setState(e)}onFocus(t){this.setState({focused:!0},this.onAutosuggest)}onBlur(t){this.setState({focused:!1})}onKeyDown(t){13===t.keyCode&&this.handleEnterKey(t),37!==t.keyCode&&39!==t.keyCode||this.onClose()}onChange(t){this.setState({value:t.target.value})}onAutosuggest(){const{value:t}=this.state,{offsetLeft:e,offsetTop:n}=this._marker,{chunk:s}=this.getCurrentChunk(t),o=this.shouldAutosuggest(s);this.setState(o?{dropdownClosed:!1,dropdownOpen:!0,dropdownValue:s,dropdownX:e,dropdownY:n+25}:{dropdownOpen:!1})}onSelectValue(t,e){void 0===e&&(e="");const{value:n}=this.state,{index:s,indexEnd:o}=this.getCurrentChunk(n),i=n.slice(0,s),r=n.slice(o),a=s+t.length+e.length;this.setState({value:""+i+t+e+r,dropdownClosed:":"!==e},()=>{this._input.focus(),this._input.setSelectionRange(a,a)})}handleEnterKey(t){const e=document.activeElement===this._input;t.shiftKey||!e||this.state.dropdownOpen||(t.preventDefault(),this.props.onSubmit(this.state.value),t.target.blur())}shouldAutosuggest(t){const{selectionStart:e}=this._input,{value:n,focused:s}=this.state,o=!n.charAt(e)||/[)\s]/.test(n.charAt(e)),i=o&&/[\s-(]/.test(n.charAt(e-1)),r=o&&/[^)\s]/.test(n.charAt(e-1));return s&&(!n||i||r&&!this.state.dropdownClosed)}onClose(t){this.setState({dropdownOpen:!1,dropdownClosed:t||!1})}extract(t){const{nameKeyIncludes:e}=this.props,{attributes:n}=this.state;return function(t,e,n){const s=[],o=F();let i;for(;null!==(i=o.exec(t));){if(e){const t=D(i,e,n);if(!t.attributeNameValid||!t.attributeValueValid)continue}s.push([i.index,o.lastIndex])}return s}(t,n,e)}getCurrentChunk(t){const{selectionStart:e}=this._input,n=this.extract(t),s=t.substring(0,e),o=s.match(/[^\s]*$/),i=o?s.lastIndexOf(o[o.length-1]):-1;let r=i;for(const[t,s]of n.reverse()){if(e>s&&i<t){r=s;break}if(e>t&&e<=s){r=t;break}if(i>t&&i<s){r=s;break}}const a=t.substring(r,e);return{index:r,indexEnd:r+a.length,chunk:a}}buildTokens(e,n){const s=[],o=this.extract(e);let i=0;return o.reduce((n,o)=>(s.push(e.substring(n[1],o[0])),s.push(/*#__PURE__*/t.createElement(yt,{key:"token-"+o[0],tokenColor:this.props.inputProps.tokenColor},e.substring(o[0],o[1]))),i=o[1],o),[null,0]),s.push(e.substring(i)),s.filter(Boolean)}buildOverlay(e){const{index:n}=this.getCurrentChunk(e),s=this.buildTokens(e.substring(0,n)),o=this.buildTokens(e.substring(n)||" ",n);return[s,/*#__PURE__*/t.createElement(ft,{key:"after-"+n,style:{outline:this.props.debug?"1px solid red":"none"},ref:t=>this._marker=t},o)]}render(){const{nameKey:e,className:n,inputProps:s,placeholder:o,keyboardHelpers:i,collapseOnBlur:r,footerComponent:a,dropdownProps:l,selectorProps:p,listProps:d,alwaysLeft:h,translations:u}=this.props,{value:c,attributes:g,dropdownOpen:b,dropdownValue:f,dropdownX:m,dropdownY:y,overlayComponents:v}=this.state,w=!this.state.focused&&r;/*#__PURE__*/return t.createElement(nt,{notify:this.onClose},/*#__PURE__*/t.createElement(dt,{className:n},/*#__PURE__*/t.createElement(ht,P({},s,{onClick:()=>this._input.focus()}),/*#__PURE__*/t.createElement(bt,{collapsed:w},v),/*#__PURE__*/t.createElement(gt,{autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",autoFocus:s.autoFocus,maxRows:w?1:void 0,placeholder:o,placeholderColor:s.placeholderColor,value:c,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onChange:this.onChange,ref:t=>this._input=t})),b&&/*#__PURE__*/t.createElement(et,{keyboardHelpers:i,footerComponent:a,attributes:g,value:f,nameKey:e,onSelect:this.onSelectValue,onClose:this.onClose,offsetX:h?0:m,offsetY:y,dropdownProps:l,selectorProps:p,listProps:d,translations:u})))}}vt.propTypes={debug:s.bool,data:s.array,nameKey:s.string,nameKeyIncludes:s.array,defaultValue:s.string,placeholder:s.string,onChange:s.func,onSubmit:s.func,keyboardHelpers:s.bool,collapseOnBlur:s.bool,footerComponent:s.func,inputProps:s.object,dropdownProps:s.object,selectorProps:s.object,listProps:s.object,alwaysLeft:s.bool,translations:s.object},vt.defaultProps={data:[],nameKey:"name",nameKeyIncludes:["name"],defaultValue:"",onChange:()=>{},onSubmit:()=>{},placeholder:"Search",inputProps:{},dropdownProps:{},selectorProps:{},listProps:{}};export{vt as QueryAssist};
//# sourceMappingURL=lib.module.js.map
